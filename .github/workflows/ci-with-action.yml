name: CI with Reusable Observability Action

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  test:
    name: ğŸ§ª Test
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ§ª Run tests with coverage
        run: |
          python -m pytest tests/ \
            --verbose \
            --tb=short \
            --cov=src \
            --cov=observability \
            --cov-report=xml:coverage.xml \
            --junit-xml=test-results.xml

      # Use the reusable observability action
      - name: ğŸ“Š CI/CD Observability
        uses: ./action
        if: always()
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          collect-job-metrics: true
          collect-test-results: true
          test-results-path: '**/test-results.xml'
          collect-coverage: true
          coverage-path: '**/coverage.xml'
          create-check: true
          upload-artifact: true
          artifact-name: 'observability-report'
          # Optional: send to external webhook
          # webhook-url: ${{ secrets.OBSERVABILITY_WEBHOOK_URL }}
          # webhook-secret: ${{ secrets.OBSERVABILITY_WEBHOOK_SECRET }}

  build:
    name: ğŸ”¨ Build
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ”¨ Build package
        run: |
          mkdir -p dist
          python -c "
          import json
          import os
          from datetime import datetime
          
          manifest = {
              'name': 'ci-cd-observability-demo',
              'version': '1.0.0',
              'build_time': datetime.now().isoformat(),
              'commit': os.environ.get('GITHUB_SHA', 'unknown'),
          }
          
          with open('dist/manifest.json', 'w') as f:
              json.dump(manifest, f, indent=2)
          print(json.dumps(manifest, indent=2))
          "

      # Observability for build job
      - name: ğŸ“Š CI/CD Observability
        uses: ./action
        if: always()
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          collect-job-metrics: true
          collect-test-results: false
          collect-coverage: false
          artifact-name: 'build-observability-report'

  deploy:
    name: ğŸš€ Deploy
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Simulate deployment
        run: |
          echo "Deploying to production..."
          sleep 2
          echo "âœ… Deployment complete!"

      # Observability for deploy job with custom metrics
      - name: ğŸ“Š CI/CD Observability
        uses: ./action
        if: always()
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          collect-job-metrics: true
          collect-test-results: false
          collect-coverage: false
          custom-metrics: |
            {
              "deployment_environment": "production",
              "deployment_type": "simulated"
            }
          artifact-name: 'deploy-observability-report'
